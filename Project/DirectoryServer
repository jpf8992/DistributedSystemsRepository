#--Directory Server--#

#What should the Directory Server do?
#A user request to open a particular file X should be passed by the client proxy to the directory server for resolution. The returned file identifier should identify the server actually holding the file (or perhaps, servers, if you have decided to expose replication to client proxies) and the name of the file on that server.

require 'socket'        #Get sockets from stdlib
currentDir = Dir.pwd	#Current Directory(default) - This can be modified to any directory to simulate server storage anywhere on the 		machine
port = 2010				#Arbitrary port for Dir Server
server = TCPServer.new(port)   	# Socket to listen on port 2010
puts "Directory Server Created on port: #{port}"
loop {                          # Servers run forever
  Thread.start(server.accept) do |client|
    
	#Process incoming message from client
	message = client.gets
	puts "Received message from Client: #{message}"
	filename = message.partition('_').last.delete!("\n")	#remove return character from string
	action_specified = message.partition('_')[0]
	puts "\nAction Specified: #{action_specified}"
	puts "File Specified : #{filename}"
	
	#List of all Folders accessible by the network - for this project, it is assumed the scope is the current directory.
	system_folders = Dir.entries(currentDir).select {|entry| File.directory? File.join(currentDir,entry) and !(entry =='.' || entry == '..') }
	#puts "type: #{system_folders.class}"
	
	file_exist = false	#initialise
	foldername = ""		#initialise
	
	if (filename != "") #only search if there is a file specified
		
		#Iterate through each folder to find file
		system_folders.each do |folder|								
			puts "\nDisplaying Contents of: #{folder}"
			puts "CurrentDir: #{File.join(currentDir,folder)}"
			file_exist = File.exists?(File.join(currentDir,folder,filename))#flag to determine if file exists
			puts "#{filename} exists (True/False):  #{file_exist}"
			if file_exist
				puts "File IS in the System #{folder}\n"
				foldername = folder
				break#exit .each loop
			else 
				puts "File NOT in System #{folder}\n"
			end
		end
	end	
	#Send message back down the socket!
	if (file_exist)	#found and command is read
		
		puts "\nSending #{foldername} back to client"
		client.puts foldername	#name of server that holds file
		puts "#{foldername} sent!\n"
		
		#replica_server_num = rand(1..3)	#random number between 1 and 3 to specify the replicated server to read from
		#puts "\nRandom Server Num: #{replica_server_num}"
		#puts "Foldername: #{foldername}"
		#replica_server = foldername[0...-1] + replica_server_num.to_s	#Specify replica to read from
		#puts "Read from Replica Server: #{replica_server}"
		#client.puts replica_server
	#elsif (file_exist && action_specified=='WRITE')	#must only write files to primary copy
		#primary_server = "Server1000"
		#client.puts primary_server
	else			#not found
		client.puts "No Such File or Directory"	#default case-the file doesn't exist on the system
	end
	puts "Closing Connection..."
    client.close                # Disconnect from the client
	puts "Connection Closed!"
  end
}